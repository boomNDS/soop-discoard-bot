Metadata-Version: 2.4
Name: soop-discord-bot
Version: 0.1.0
Summary: Community Discord bot that posts SOOP live notifications.
Author: Community
License: MIT License
        
        Copyright (c) 2026 Pach0n
        
        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:
        
        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.
        
        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
        
Requires-Python: >=3.12
Description-Content-Type: text/markdown
License-File: LICENSE
Requires-Dist: fastapi>=0.110
Requires-Dist: uvicorn[standard]>=0.27
Requires-Dist: py-cord>=2.5.0
Requires-Dist: httpx>=0.27
Requires-Dist: python-dotenv>=1.0
Requires-Dist: sqlalchemy>=2.0
Requires-Dist: alembic>=1.13
Provides-Extra: dev
Requires-Dist: ruff>=0.4; extra == "dev"
Requires-Dist: pytest>=8.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.23; extra == "dev"
Dynamic: license-file

# soop-discoard-bot

Community Discord bot that posts live notifications from SOOP to your Discord server. Not affiliated with SOOP.

## Goals

- Let server admins invite the bot and link multiple SOOP streamers/channels with commands.
- Send a Discord notification when any linked streamer goes live on SOOP.
- Run as a production-ready Python service using FastAPI and uv.

## Architecture

- **Discord bot**: Slash commands for `/link`, `/unlink`, `/status`, `/test`.
- **FastAPI service**: Health checks and a lightweight API surface for future webhook integration.
- **Storage**: Persist guild → SOOP channel mappings (SQLite or Postgres), supports multiple streamers.
- **Notifier**: Posts to configured Discord channels when live events occur.

## Quick Start (local)

### Discord Bot Setup (one-time)

1) Go to the Discord Developer Portal and create a new application.
2) In **Bot**:
   - Click **Add Bot**.
   - Copy **Bot Token** and **Application ID**.
3) In **OAuth2 → URL Generator**:
   - Scopes: `bot`, `applications.commands`
   - Bot Permissions: **View Channels**, **Send Messages**, **Read Message History**
4) Use the generated invite URL to add the bot to your server.

1) Create and fill `.env` (see Configuration).
   - You can start from `.env.example`.
2) Install dependencies and run:

```bash
uv sync
uv run uvicorn soop_discord_bot.app.main:app --host 0.0.0.0 --port 8000
```

3) Start the Discord bot worker:

```bash
uv run python -m soop_discord_bot.bot
```
> Live detection uses `/broad/list` and matches `user_id` values. Adjust parsing in `soop_discord_bot/soop/client.py` if needed.

## Configuration

| Variable | Description | Required |
| --- | --- | --- |
| DISCORD_TOKEN | Discord bot token | Yes |
| DISCORD_APPLICATION_ID | Discord application ID | Yes |
| DISCORD_GUILD_ID | Optional dev guild for faster command sync | No |
| SOOP_API_BASE_URL | SOOP API base URL | Yes |
| SOOP_CLIENT_ID | SOOP OpenAPI client_id | Yes |
| NOTIFY_CHANNEL_ID | Default Discord channel for notifications | No |
| DATABASE_URL | Database connection string | Yes |
| POLL_INTERVAL_SECONDS | Polling interval in seconds | No |
| SOOP_MAX_PAGES | Max pages to scan per poll | No |
| NOTIFY_RATE_PER_SECOND | Max notification send rate | No |
| NOTIFY_BURST_RATE_PER_SECOND | Burst send rate when queue is large | No |
| NOTIFY_BURST_THRESHOLD | Queue size that triggers burst mode | No |
| SHARD_COUNT | Discord shard count (scale) | No |
| LOG_LEVEL | Logging level (info, debug) | No |

SOOP API docs (reference):

```
https://openapi.sooplive.co.kr/apidoc#broadcast-filtering-registrationmodificationpost
```

Live detection currently uses the `/broad/list` endpoint and matches `user_id` against linked streamers.

## Discord Commands

- `/link soop_channel:<id> notify_channel:<#channel>`
- `/unlink soop_channel:<id>`
- `/unlink_all`
- `/status` (lists linked streamers)
- `/test [soop_channel:<id>]`
- `/template action:<set|clear|list> soop_channel:<id> message_template:<text>`

## Deployment (Docker)

Build the container:

```bash
docker build -t soop-discord-bot:latest .
```

Run with environment variables:

```bash
docker run --rm -p 8000:8000 \
  --env-file .env \
  soop-discord-bot:latest
```

For production, run the bot and API as separate processes (recommended):

- **API**: `uv run uvicorn soop_discord_bot.app.main:app --host 0.0.0.0 --port 8000`
- **Bot worker**: `uv run python -m soop_discord_bot.bot`

### Docker Compose (recommended)

```bash
docker compose up --build
```

The compose file runs two services (api + bot) and shares a persistent SQLite volume.

## Migrations

Run database migrations with Alembic:

```bash
uv run alembic upgrade head
```

## Tests

```bash
uv run pytest
```

## Contributing

See `CONTRIBUTING.md`.

## License

MIT. See `LICENSE`.
